<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Web Development with Ruby on Rails Tutorial 2019">
<meta name="author" content="Scott Fleming">

<link rel="shortcut icon" type="image/png" href="/rails-demos-n-deets-2020/assets/img/favicon.png">

<title>Creating and Testing Valid Fixtures | Ruby on Rails ⇨ Demos 'n' Deets</title>

        <!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<!-- Custom styles for this site -->
<link href="/rails-demos-n-deets-2020/assets/css/site.css" rel="stylesheet">

    </head>
    <body>
        


<header>
    <nav class="navbar navbar-expand-md navbar-light bg-light">
        <a class="navbar-brand" href="/rails-demos-n-deets-2020/"><img src="/rails-demos-n-deets-2020/assets/img/brand.png" style="height: 3.5rem"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item ">
                    <a class="nav-link" href="/rails-demos-n-deets-2020/">Home</a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/rails-demos-n-deets-2020/about/">About</a>
                </li>
                </ul>
        </div>
    </nav>
</header>

        <main role="main">

            <div class="container mt-4">
                <h1 id="creating-and-testing-valid-fixtures">Creating and Testing Valid Fixtures</h1>

<p>In this demonstration, I will show how to create <em>fixtures</em> (i.e., sample data) for model tests and how to write tests to verify that all the fixtures for a particular model are valid. We will continue to build upon the <a href="https://github.com/human-se/quiz-me-2020" target="_blank">QuizMe project</a> from the previous demos.</p>

<p><a href="https://en.wikipedia.org/wiki/Unit_testing" target="_blank">Unit tests</a> aim to verify that individual “units” of code (e.g., classes and methods) work correctly. Rails includes a <a href="https://en.wikipedia.org/wiki/Test_harness" target="_blank">test harness</a> that provides automation to help developers to write tests for various units of Rails application code (e.g., model classes) and to run those test in batches. In this demo, we will use the Rails test harness to unit test our <code class="highlighter-rouge">McQuestions</code> model class.</p>

<p>To accomplish this goal, we will perform the following steps:</p>

<ol>
  <li>Remove some controller test code that was previously generated by a <code class="highlighter-rouge">rails g controller</code> command. This code became broken because of customizations we made (e.g., to the <code class="highlighter-rouge">routes.rb</code> file).</li>
  <li>Create a couple <code class="highlighter-rouge">McQuestion</code> test fixtures to use in our model tests.</li>
  <li>Write unit tests that verify that our <code class="highlighter-rouge">McQuestion</code> class is free of syntax errors and that our <code class="highlighter-rouge">McQuestion</code> fixtures are all valid.</li>
</ol>

<h2 id="1-cleaning-up-generated-mcquestionscontroller-tests">1. Cleaning Up Generated <code class="highlighter-rouge">McQuestionsController</code> Tests</h2>

<p>When <code class="highlighter-rouge">rails</code> is used to generate a controller class (like we did in previous demos), it also generates some default tests for the controller class, including some “controller tests”; however, the controller tests assume the default routes generated by <code class="highlighter-rouge">rails</code>. When we customize the routes (as we are apt to do), it breaks these controller tests. Thus, to solve this problem, we commonly just comment out the generated controller tests initially, and later update them to fit for our particular app.</p>

<p>To remove the generated controller tests, use VS Code to edit the Ruby files in <code class="highlighter-rouge">test/controllers</code>, and comment out any tests there that you yourself did not write (all of them at this stage). In a later demo, we will write controller tests specifically designed for the QuizMe project.</p>

<p><strong><a href="https://github.com/human-se/quiz-me-2020/commit/7bc4b6821d1a7a44ff3209c0e8d17bc8f35498ef" target="_blank">{% octicon git-commit height:24 class:"right left" aria-label:hi %} Code changeset for this part</a></strong></p>

<h2 id="2-creating-valid-mcquestion-fixtures">2. Creating Valid <code class="highlighter-rouge">McQuestion</code> Fixtures</h2>

<p>In Rails, the fixtures for each model are stored in a <a href="https://en.wikipedia.org/wiki/YAML">YAML</a> (<code class="highlighter-rouge">.yml</code>) file in the <code class="highlighter-rouge">test/fixtures</code> directory. Looking at the <code class="highlighter-rouge">mc_questions.yml</code> file, we can see that a couple of default fixtures were generated automatically, named <code class="highlighter-rouge">one</code> and <code class="highlighter-rouge">two</code>. We will edit those two fixtures to give them attribute values more germane to multiple-choice questions. These fixtures are to all contain valid <code class="highlighter-rouge">McQuestion</code> sample data (no blank or missing questions, no blank or missing answers, etc.).</p>

<p>Replace fixture <code class="highlighter-rouge">one</code> with the following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">one</span><span class="pi">:</span>
  <span class="na">question</span><span class="pi">:</span> <span class="s">By default, every Rails model is a subclass of which superclass?</span>
  <span class="na">answer</span><span class="pi">:</span> <span class="s">ApplicationRecord</span>
  <span class="na">distractor_1</span><span class="pi">:</span> <span class="s">Object</span>
  <span class="na">distractor_2</span><span class="pi">:</span> <span class="s">ActiveModel</span>
</code></pre></div></div>

<p>True/false questions are another valid kind of multiple-choice question. Replace fixture <code class="highlighter-rouge">two</code> with the following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">two</span><span class="pi">:</span>
  <span class="na">question</span><span class="pi">:</span> <span class="s">The command rails db:migrate updates the schema.rb file.</span>
  <span class="na">answer</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">distractor_1</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">distractor_2</span><span class="pi">:</span> <span class="c1"># blank loads as nil</span>
</code></pre></div></div>

<p>Once the above changes are completed, every <code class="highlighter-rouge">McQuestion</code> model test will be able to retrieve these fixtures for use in their test code.</p>

<p><strong><a href="https://github.com/human-se/quiz-me-2020/commit/e03cfff43eecd3e9fc7b8502c94e396fbd704ca6" target="_blank">{% octicon git-commit height:24 class:"right left" aria-label:hi %} Code changeset for this part</a></strong></p>

<h2 id="3-testing-the-valid-mcquestion-fixtures">3. Testing the Valid <code class="highlighter-rouge">McQuestion</code> Fixtures</h2>

<p>Now that we have some fixtures, we will write a test that checks the fixtures to make sure that the app also sees them as valid. If the test fails, then we either accidentally introduced a bug into our model code or made a mistake in the fixture, and we will have to locate and fix the bug.</p>

<p>When we used <code class="highlighter-rouge">rails</code> to generate the <code class="highlighter-rouge">McQuestion</code> model, <code class="highlighter-rouge">rails</code> also generated a test file <code class="highlighter-rouge">test/models/mc_question_test.rb</code>. That test file is where we should put any model tests we write for the <code class="highlighter-rouge">McQuestion</code> class.</p>

<p>Rails model tests usually follow three basic steps:</p>

<ol>
  <li>First, the test retrieves one or more fixtures (i.e., valid model objects for testing).</li>
  <li>Next, the test may (or may not, depending on what it’s testing) set the attribute values of the fixture objects, commonly to make them invalid.</li>
  <li>Finally, the test makes one or more <em>assertions</em> about the fixtures. Each assertion aims to check that some condition is true. If all of a test’s assertions are true, then the test passes; however, if an assertion is discovered to be false, then the test fails.</li>
</ol>

<p>Rails model tests are considered a kind of unit test, so they should be small and focus on testing only one thing. However, you can check multiple details about that one thing by adding multiple assertions to the same test.</p>

<h3 id="31-creating-a-test-for-a-single-valid-mcquestion-fixture">3.1. Creating a Test for a Single Valid <code class="highlighter-rouge">McQuestion</code> Fixture</h3>

<p>Although our ultimate goal is to test all the <code class="highlighter-rouge">McQuestion</code> fixtures, as a first step, we will write a test that tests only one fixture, <code class="highlighter-rouge">one</code>, to verify that the system considers it valid.</p>

<p>In the body of the <code class="highlighter-rouge">McQuestionTest</code> class, insert an empty test with the name “<code class="highlighter-rouge">fixtures are valid</code>”, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"fixtures are valid"</span> <span class="k">do</span>
  <span class="c1"># TODO</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Next, retrieve the test fixture <code class="highlighter-rouge">one</code> object by inserting a line of code, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"fixtures are valid"</span> <span class="k">do</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">mc_questions</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="c1"># TODO</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Rails automatically provides the <code class="highlighter-rouge">mc_questions</code> method (same name as fixture’s YAML file). When called, as above, with a symbol argument (<code class="highlighter-rouge">:one</code>) corresponding to the name of a test in the YAML file, the method will return the associated fixture object from the database.</p>

<p>Finally, check that the object is valid by inserting an <a href="https://guides.rubyonrails.org/v6.0.2.1/testing.html#available-assertions" target="_blank"><code class="highlighter-rouge">assert</code> statement</a>, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"fixtures are valid"</span> <span class="k">do</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">mc_questions</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">assert</span> <span class="n">q</span><span class="p">.</span><span class="nf">valid?</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span><span class="p">.</span><span class="nf">inspect</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, when this test executes, if the call to the <a href="https://api.rubyonrails.org/v6.0.2.1/classes/ActiveRecord/Validations.html#method-i-valid-3F" target="_blank"><code class="highlighter-rouge">valid?</code> method</a> returns <code class="highlighter-rouge">false</code>, indicating that the <code class="highlighter-rouge">McQuestion</code> object referenced by <code class="highlighter-rouge">q</code> is not valid, then the test will fail, printing error messages to the console.</p>

<p>Note that, for this test, we skipped step 2 mentioned above (setting fixture attributes), because this test doesn’t need to change any of the fixture’s attribute values.</p>

<p>Make sure that the test passes to confirm that everything is working by entering the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails <span class="nb">test</span>
</code></pre></div></div>

<p>You should see an output message that looks like this, indicating that all tests passed:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Finished in 0.126389s, 7.9121 runs/s, 7.9121 assertions/s.
1 runs, 1 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>The number of <code class="highlighter-rouge">runs</code> indicates how many <code class="highlighter-rouge">test</code> methods executed. The number of <code class="highlighter-rouge">assertions</code> indicates how many assertions ran within those <code class="highlighter-rouge">test</code> methods. The number of <code class="highlighter-rouge">failures</code> indicates many of those assertions were violated. The number of <code class="highlighter-rouge">errors</code> indicates how many <code class="highlighter-rouge">test</code> methods crashed (e.g., due to syntax errors or thrown exceptions in the code under test).</p>

<p><strong><a href="https://github.com/human-se/quiz-me-2020/commit/877c1ba88e9269b9f2e38f83220930962d959205" target="_blank">{% octicon git-commit height:24 class:"right left" aria-label:hi %} Code changeset for this part</a></strong></p>

<h3 id="32-updating-the-test-to-cover-all-the-valid-mcquestion-fixtures">3.2. Updating the Test to Cover All the Valid <code class="highlighter-rouge">McQuestion</code> Fixtures</h3>

<p>Now that we have a test to verify that <code class="highlighter-rouge">McQuestion</code> fixture <code class="highlighter-rouge">one</code> is valid, what we would really like to do is to test that all of the <code class="highlighter-rouge">McQuestion</code> fixtures are valid. To do so, we could copy/paste/modify the code we already have to add a second assertion for fixture <code class="highlighter-rouge">two</code>, but if we do that, we’re setting ourselves up to do a copy/paste/modify for every fixture we want to test. Right now, there are only two fixtures, but we might add more later. To save us from tedious and error-prone copy/paste/modify edits, we will instead simply iterate through all the fixtures and assert that each one is valid. Thus, we will update the above test code as follows.</p>

<p>To begin with, remove the previous body of the test to give us a clean starting place, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"fixtures are valid"</span> <span class="k">do</span>
  <span class="c1"># TODO</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Next, iterate through all the <code class="highlighter-rouge">McQuestion</code> fixtures by inserting an <code class="highlighter-rouge">each</code> loop, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"fixtures are valid"</span> <span class="k">do</span>
  <span class="n">mc_questions</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span>
    <span class="c1"># TODO</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that when called with no arguments, the <code class="highlighter-rouge">mc_questions</code> method returns a collection of all the <code class="highlighter-rouge">McQuestion</code> fixture objects.</p>

<p>Finally, assert that each <code class="highlighter-rouge">McQuestion</code> object is valid by inserting an <code class="highlighter-rouge">assert</code> statement similar to the one above, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"fixtures are valid"</span> <span class="k">do</span>
  <span class="n">mc_questions</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span>
    <span class="n">assert</span> <span class="n">q</span><span class="p">.</span><span class="nf">valid?</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span><span class="p">.</span><span class="nf">inspect</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Using the same <code class="highlighter-rouge">rails</code> command as above, re-run the tests to verify that they all pass and that everything is working properly. Note that the test output now shows that <code class="highlighter-rouge">2 assertions</code> executed, one for each of our <code class="highlighter-rouge">McQuestion</code> fixtures.</p>

<p>We now have an automated test that we can run again and again to ensure that we haven’t introduced any errors into our <code class="highlighter-rouge">McQuestion</code> model code or our <code class="highlighter-rouge">McQuestion</code> fixtures.</p>

<p>For more information on fixtures, see the <a href="https://guides.rubyonrails.org/v6.0.2.1/testing.html#the-low-down-on-fixtures" target="_blank">Rails Guides page</a> and <a href="https://api.rubyonrails.org/v6.0.2.1/classes/ActiveRecord/FixtureSet.html" target="_blank">API documentation</a>.</p>

<p><strong><a href="https://github.com/human-se/quiz-me-2020/commit/a52ca1153bb3e54bea122ab834653c06b2440762" target="_blank">{% octicon git-commit height:24 class:"right left" aria-label:hi %} Code changeset for this part</a></strong></p>

<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        
            
            <li class="page-item"><a class="page-link" href="/rails-demos-n-deets-2020/demo-model-show/">⇦ Previous: Displaying a Single Model Record</a></li>
        
        
            
            <li class="page-item"><a class="page-link" href="/rails-demos-n-deets-2020/demo-presence-validations/">⇨ Next: Creating and Testing Presence Validations</a></li>
        
    </ul>
</nav>


            </div> <!-- /.container -->

        </main>

        <footer class="container">
            <hr style="margin-top: 2rem;">
            <p style="text-align: center;">
                &copy; <a href="/about/">The Authors</a> 2020
            </p>
        </footer>

        <!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    </body>
</html>
